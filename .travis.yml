dist: xenial
language: python
stages:
  - "Static code analysis"
  - test
  - deploy
python:
  - "3.5"
  - "3.6"
  - "3.7"
notifications:
  email: false
install:
  - pip install -qq --upgrade pip docargs coverage coveralls
  - pip install -qq '.[tests,examples]'
script:
  - coverage run --source=src/ -m pytest
  - find docs -name '*.ipynb' -o -name 'examples/*.ipynb' | xargs jupyter nbconvert --to notebook --execute
  - coveralls
jobs:
  include:
    - stage: "Static code analysis"
      name: "black formatting test"
      script:
        - pip install -qq black
        - black --check src/
      python: "3.7"
      install: skip
    - stage: "Static code analysis"
      name: "flake8 check"
      script:
        - pip install -qq flake8 docargs
        - flake8 src/
      python: "3.7"
      install: skip
    - stage: deploy
      name: "Deploy to pypi"
      if: (branch = master) AND (tag IS present)
      script:
        - pip install poetry
        - poetry build
        - poetry publish --username $PYPI_USER --password $PYPI_PASSWORD
      python: "3.7"
